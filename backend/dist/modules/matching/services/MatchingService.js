"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MatchingService = void 0;
class MatchingService {
    /**
     * Ranks nearby helpers using a multi-objective scoring function.
     * Score = (Trust * 0.4) + (Log(saves+1) * 0.2) + (1/Distance * 0.4)
     */
    static rankHelpers(incidentLat, incidentLng, helpers) {
        return helpers.map(helper => {
            const distance = this.calculateDistance(incidentLat, incidentLng, helper.location?.lat || 0, helper.location?.lng || 0);
            // Mock trust and saves if missing for scoring demo
            const trust = helper.isVerified ? 100 : 50;
            const saves = helper.stats?.saves || 0;
            // Normalize distance (Max score for < 500m, decays after)
            const distanceScore = Math.max(0, 100 - (distance / 50));
            const matchScore = (trust * 0.4) + (Math.log1p(saves) * 20) + (distanceScore * 0.4);
            return {
                helper,
                matchScore,
                distance_m: distance
            };
        }).sort((a, b) => b.matchScore - a.matchScore);
    }
    static calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // metres
        const φ1 = lat1 * Math.PI / 180;
        const φ2 = lat2 * Math.PI / 180;
        const Δφ = (lat2 - lat1) * Math.PI / 180;
        const Δλ = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
            Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }
}
exports.MatchingService = MatchingService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWF0Y2hpbmdTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL21vZHVsZXMvbWF0Y2hpbmcvc2VydmljZXMvTWF0Y2hpbmdTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQVFBLE1BQWEsZUFBZTtJQUN4Qjs7O09BR0c7SUFDSSxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQW1CLEVBQUUsV0FBbUIsRUFBRSxPQUFnQjtRQUNoRixPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDeEIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUNuQyxXQUFXLEVBQ1gsV0FBVyxFQUNYLE1BQU0sQ0FBQyxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFDekIsTUFBTSxDQUFDLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUM1QixDQUFDO1lBRUYsbURBQW1EO1lBQ25ELE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQzNDLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQztZQUV2QywwREFBMEQ7WUFDMUQsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFFekQsTUFBTSxVQUFVLEdBQUcsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsYUFBYSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBRXBGLE9BQU87Z0JBQ0gsTUFBTTtnQkFDTixVQUFVO2dCQUNWLFVBQVUsRUFBRSxRQUFRO2FBQ3ZCLENBQUM7UUFDTixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRU8sTUFBTSxDQUFDLGlCQUFpQixDQUFDLElBQVksRUFBRSxJQUFZLEVBQUUsSUFBWSxFQUFFLElBQVk7UUFDbkYsTUFBTSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsU0FBUztRQUMzQixNQUFNLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUM7UUFDaEMsTUFBTSxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDO1FBQ2hDLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDO1FBQ3pDLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDO1FBRXpDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUN6QyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUMzQixJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN4QyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFekQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pCLENBQUM7Q0FDSjtBQTdDRCwwQ0E2Q0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJVXNlciB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC90eXBlcy9kb21haW4nO1xuXG5leHBvcnQgaW50ZXJmYWNlIElNYXRjaFJlc3VsdCB7XG4gICAgaGVscGVyOiBJVXNlcjtcbiAgICBtYXRjaFNjb3JlOiBudW1iZXI7XG4gICAgZGlzdGFuY2VfbTogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgTWF0Y2hpbmdTZXJ2aWNlIHtcbiAgICAvKipcbiAgICAgKiBSYW5rcyBuZWFyYnkgaGVscGVycyB1c2luZyBhIG11bHRpLW9iamVjdGl2ZSBzY29yaW5nIGZ1bmN0aW9uLlxuICAgICAqIFNjb3JlID0gKFRydXN0ICogMC40KSArIChMb2coc2F2ZXMrMSkgKiAwLjIpICsgKDEvRGlzdGFuY2UgKiAwLjQpXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyByYW5rSGVscGVycyhpbmNpZGVudExhdDogbnVtYmVyLCBpbmNpZGVudExuZzogbnVtYmVyLCBoZWxwZXJzOiBJVXNlcltdKTogSU1hdGNoUmVzdWx0W10ge1xuICAgICAgICByZXR1cm4gaGVscGVycy5tYXAoaGVscGVyID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRpc3RhbmNlID0gdGhpcy5jYWxjdWxhdGVEaXN0YW5jZShcbiAgICAgICAgICAgICAgICBpbmNpZGVudExhdCxcbiAgICAgICAgICAgICAgICBpbmNpZGVudExuZyxcbiAgICAgICAgICAgICAgICBoZWxwZXIubG9jYXRpb24/LmxhdCB8fCAwLFxuICAgICAgICAgICAgICAgIGhlbHBlci5sb2NhdGlvbj8ubG5nIHx8IDBcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIC8vIE1vY2sgdHJ1c3QgYW5kIHNhdmVzIGlmIG1pc3NpbmcgZm9yIHNjb3JpbmcgZGVtb1xuICAgICAgICAgICAgY29uc3QgdHJ1c3QgPSBoZWxwZXIuaXNWZXJpZmllZCA/IDEwMCA6IDUwO1xuICAgICAgICAgICAgY29uc3Qgc2F2ZXMgPSBoZWxwZXIuc3RhdHM/LnNhdmVzIHx8IDA7XG5cbiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSBkaXN0YW5jZSAoTWF4IHNjb3JlIGZvciA8IDUwMG0sIGRlY2F5cyBhZnRlcilcbiAgICAgICAgICAgIGNvbnN0IGRpc3RhbmNlU2NvcmUgPSBNYXRoLm1heCgwLCAxMDAgLSAoZGlzdGFuY2UgLyA1MCkpO1xuXG4gICAgICAgICAgICBjb25zdCBtYXRjaFNjb3JlID0gKHRydXN0ICogMC40KSArIChNYXRoLmxvZzFwKHNhdmVzKSAqIDIwKSArIChkaXN0YW5jZVNjb3JlICogMC40KTtcblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBoZWxwZXIsXG4gICAgICAgICAgICAgICAgbWF0Y2hTY29yZSxcbiAgICAgICAgICAgICAgICBkaXN0YW5jZV9tOiBkaXN0YW5jZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSkuc29ydCgoYSwgYikgPT4gYi5tYXRjaFNjb3JlIC0gYS5tYXRjaFNjb3JlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBjYWxjdWxhdGVEaXN0YW5jZShsYXQxOiBudW1iZXIsIGxvbjE6IG51bWJlciwgbGF0MjogbnVtYmVyLCBsb24yOiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBSID0gNjM3MWUzOyAvLyBtZXRyZXNcbiAgICAgICAgY29uc3Qgz4YxID0gbGF0MSAqIE1hdGguUEkgLyAxODA7XG4gICAgICAgIGNvbnN0IM+GMiA9IGxhdDIgKiBNYXRoLlBJIC8gMTgwO1xuICAgICAgICBjb25zdCDOlM+GID0gKGxhdDIgLSBsYXQxKSAqIE1hdGguUEkgLyAxODA7XG4gICAgICAgIGNvbnN0IM6UzrsgPSAobG9uMiAtIGxvbjEpICogTWF0aC5QSSAvIDE4MDtcblxuICAgICAgICBjb25zdCBhID0gTWF0aC5zaW4ozpTPhiAvIDIpICogTWF0aC5zaW4ozpTPhiAvIDIpICtcbiAgICAgICAgICAgIE1hdGguY29zKM+GMSkgKiBNYXRoLmNvcyjPhjIpICpcbiAgICAgICAgICAgIE1hdGguc2luKM6UzrsgLyAyKSAqIE1hdGguc2luKM6UzrsgLyAyKTtcbiAgICAgICAgY29uc3QgYyA9IDIgKiBNYXRoLmF0YW4yKE1hdGguc3FydChhKSwgTWF0aC5zcXJ0KDEgLSBhKSk7XG5cbiAgICAgICAgcmV0dXJuIFIgKiBjO1xuICAgIH1cbn1cbiJdfQ==