"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SocketService = void 0;
const socket_io_1 = require("socket.io");
const redis_adapter_1 = require("@socket.io/redis-adapter");
const redis_1 = require("redis");
class SocketService {
    constructor() {
        this.io = null;
    }
    static getInstance() {
        if (!SocketService.instance) {
            SocketService.instance = new SocketService();
        }
        return SocketService.instance;
    }
    async init(server) {
        this.io = new socket_io_1.Server(server, {
            cors: {
                origin: "*",
                methods: ["GET", "POST"]
            }
        });
        // Setup Redis Adapter for High Availability
        if (process.env.REDIS_URL) {
            const pubClient = (0, redis_1.createClient)({ url: process.env.REDIS_URL });
            const subClient = pubClient.duplicate();
            await Promise.all([pubClient.connect(), subClient.connect()]);
            this.io.adapter((0, redis_adapter_1.createAdapter)(pubClient, subClient));
            console.log("ðŸ“¡ WebSocket Redis Adapter enabled for HA scaling.");
        }
        this.io.on('connection', (socket) => {
            console.log('User connected to Rescue v2:', socket.id);
            socket.on('emergency:sos', (data) => {
                console.log('ðŸ†˜ SOS ALARM (v2):', data);
                // Business logic for broadcast will go here or in a dedicated SocketHandler
                socket.broadcast.emit('mission:offered', data);
            });
            socket.on('disconnect', () => {
                console.log('User disconnected from Rescue v2');
            });
        });
    }
    getIO() {
        if (!this.io) {
            throw new Error('Socket.io not initialized!');
        }
        return this.io;
    }
}
exports.SocketService = SocketService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU29ja2V0U2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbmZyYS9zb2NrZXQvU29ja2V0U2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx5Q0FBNkQ7QUFFN0QsNERBQXlEO0FBQ3pELGlDQUFxQztBQUVyQyxNQUFhLGFBQWE7SUFBMUI7UUFFWSxPQUFFLEdBQTBCLElBQUksQ0FBQztJQStDN0MsQ0FBQztJQTdDVSxNQUFNLENBQUMsV0FBVztRQUNyQixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzFCLGFBQWEsQ0FBQyxRQUFRLEdBQUcsSUFBSSxhQUFhLEVBQUUsQ0FBQztRQUNqRCxDQUFDO1FBQ0QsT0FBTyxhQUFhLENBQUMsUUFBUSxDQUFDO0lBQ2xDLENBQUM7SUFFTSxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQWtCO1FBQ2hDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxrQkFBYyxDQUFDLE1BQU0sRUFBRTtZQUNqQyxJQUFJLEVBQUU7Z0JBQ0YsTUFBTSxFQUFFLEdBQUc7Z0JBQ1gsT0FBTyxFQUFFLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQzthQUMzQjtTQUNKLENBQUMsQ0FBQztRQUVILDRDQUE0QztRQUM1QyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDeEIsTUFBTSxTQUFTLEdBQUcsSUFBQSxvQkFBWSxFQUFDLEVBQUUsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztZQUMvRCxNQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDeEMsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxFQUFFLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDOUQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBQSw2QkFBYSxFQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3JELE9BQU8sQ0FBQyxHQUFHLENBQUMsb0RBQW9ELENBQUMsQ0FBQztRQUN0RSxDQUFDO1FBRUQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUMsTUFBYyxFQUFFLEVBQUU7WUFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFdkQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxJQUFTLEVBQUUsRUFBRTtnQkFDckMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDeEMsNEVBQTRFO2dCQUM1RSxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNuRCxDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRTtnQkFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1lBQ3BELENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0sS0FBSztRQUNSLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDWCxNQUFNLElBQUksS0FBSyxDQUFDLDRCQUE0QixDQUFDLENBQUM7UUFDbEQsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUNuQixDQUFDO0NBQ0o7QUFqREQsc0NBaURDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2VydmVyIGFzIFNvY2tldElPU2VydmVyLCBTb2NrZXQgfSBmcm9tICdzb2NrZXQuaW8nO1xuaW1wb3J0IHsgU2VydmVyIGFzIEh0dHBTZXJ2ZXIgfSBmcm9tICdodHRwJztcbmltcG9ydCB7IGNyZWF0ZUFkYXB0ZXIgfSBmcm9tICdAc29ja2V0LmlvL3JlZGlzLWFkYXB0ZXInO1xuaW1wb3J0IHsgY3JlYXRlQ2xpZW50IH0gZnJvbSAncmVkaXMnO1xuXG5leHBvcnQgY2xhc3MgU29ja2V0U2VydmljZSB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IFNvY2tldFNlcnZpY2U7XG4gICAgcHJpdmF0ZSBpbzogU29ja2V0SU9TZXJ2ZXIgfCBudWxsID0gbnVsbDtcblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogU29ja2V0U2VydmljZSB7XG4gICAgICAgIGlmICghU29ja2V0U2VydmljZS5pbnN0YW5jZSkge1xuICAgICAgICAgICAgU29ja2V0U2VydmljZS5pbnN0YW5jZSA9IG5ldyBTb2NrZXRTZXJ2aWNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFNvY2tldFNlcnZpY2UuaW5zdGFuY2U7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGluaXQoc2VydmVyOiBIdHRwU2VydmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHRoaXMuaW8gPSBuZXcgU29ja2V0SU9TZXJ2ZXIoc2VydmVyLCB7XG4gICAgICAgICAgICBjb3JzOiB7XG4gICAgICAgICAgICAgICAgb3JpZ2luOiBcIipcIixcbiAgICAgICAgICAgICAgICBtZXRob2RzOiBbXCJHRVRcIiwgXCJQT1NUXCJdXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFNldHVwIFJlZGlzIEFkYXB0ZXIgZm9yIEhpZ2ggQXZhaWxhYmlsaXR5XG4gICAgICAgIGlmIChwcm9jZXNzLmVudi5SRURJU19VUkwpIHtcbiAgICAgICAgICAgIGNvbnN0IHB1YkNsaWVudCA9IGNyZWF0ZUNsaWVudCh7IHVybDogcHJvY2Vzcy5lbnYuUkVESVNfVVJMIH0pO1xuICAgICAgICAgICAgY29uc3Qgc3ViQ2xpZW50ID0gcHViQ2xpZW50LmR1cGxpY2F0ZSgpO1xuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW3B1YkNsaWVudC5jb25uZWN0KCksIHN1YkNsaWVudC5jb25uZWN0KCldKTtcbiAgICAgICAgICAgIHRoaXMuaW8uYWRhcHRlcihjcmVhdGVBZGFwdGVyKHB1YkNsaWVudCwgc3ViQ2xpZW50KSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIvCfk6EgV2ViU29ja2V0IFJlZGlzIEFkYXB0ZXIgZW5hYmxlZCBmb3IgSEEgc2NhbGluZy5cIik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmlvLm9uKCdjb25uZWN0aW9uJywgKHNvY2tldDogU29ja2V0KSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnVXNlciBjb25uZWN0ZWQgdG8gUmVzY3VlIHYyOicsIHNvY2tldC5pZCk7XG5cbiAgICAgICAgICAgIHNvY2tldC5vbignZW1lcmdlbmN5OnNvcycsIChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygn8J+GmCBTT1MgQUxBUk0gKHYyKTonLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAvLyBCdXNpbmVzcyBsb2dpYyBmb3IgYnJvYWRjYXN0IHdpbGwgZ28gaGVyZSBvciBpbiBhIGRlZGljYXRlZCBTb2NrZXRIYW5kbGVyXG4gICAgICAgICAgICAgICAgc29ja2V0LmJyb2FkY2FzdC5lbWl0KCdtaXNzaW9uOm9mZmVyZWQnLCBkYXRhKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzb2NrZXQub24oJ2Rpc2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1VzZXIgZGlzY29ubmVjdGVkIGZyb20gUmVzY3VlIHYyJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldElPKCk6IFNvY2tldElPU2VydmVyIHtcbiAgICAgICAgaWYgKCF0aGlzLmlvKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldC5pbyBub3QgaW5pdGlhbGl6ZWQhJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuaW87XG4gICAgfVxufVxuIl19